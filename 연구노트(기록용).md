# 연구노트

**잘 동작하는 파서를 구현해보자.**

* **참고사이트**
  * [셀레니움4 공식문서](https://www.selenium.dev/documentation/webdriver/browsers/chrome/)
  * [셀레니움-오류해결 공유](https://cat-minzzi.tistory.com/28)
  * **[ERDCloud](https://www.erdcloud.com/d/N8nnR7nSiPHhx4BpL)**
  
* 깃으로 형상관리
  * 보안을 위해 properties같은 파일에 따로 개인정보 기록
  * 보안을 위해 호스팅 서버에서만 동작하도록 리눅스 권한설정(properties 같은파일 접근할때 말함)
    * 이왕이면 url정보도 이렇게 숨기는게 안전할듯
    * url정보는 아직 안숨겼으니 꼭 숨기자.
  * 이정도만 하면 충분히 public으로 깃 관리해도 될듯(ㅇ.ㅇ)
* 기존 git-action 사용하던건??
  * 보통 코드 테스트용도로 많이쓰는걸로 아는데 이쪽으로 활용해보자.
  * 예로 그냥 로그인 필요없는 홈페이지 파싱같은건 쓸만하지 않겠나??
  * 정확히 어느정도 테스트에 쓰는지는 공부해보고 사용
* 유연하게 사용할 수 있는 파서가 되도록 구현해보자 -> 추후에 다른 사이트들에도 사용하기 쉽게끔
* 호스팅 서버에 python동작을 cgi로 할거냐 장고로 할거냐?
  * 호스팅 서버에 동작시킬건데 셀레니움으로 파서만 구현할테니까 그냥 cgi 방식으로 python 구동하면 될듯
* 성능개선은 ??
  * **멀티스레드, 멀티프로세스** 적용해서 구현하는걸로 하자
  * **Selenium Grid 4 (Docker Container)**: 하나의 script으로 원격 실행이 가능합니다. Docker의 Container를 사용해서 다수의 가상 머신에 Selenium을 배포하고 실행할 수 있습니다. 
    * 이거는 우선 넘어가고 나중에 도커를 잘 쓰게 될때 다시한번 체크해보자. 셀레니움4의 핵심추가기능

* 스케줄링(crontab) 으로 파서들 관리할 예정 -> 보통 하루 한번만 파싱하면 대부분 충분
  * 만약 자주 파싱해야할수도 있는 그런건 바로 파싱보다는 쿼리날려서 최신께 나왔는지 먼저 확인 필수
* **DB에는 데이터 저장을 할 것인가?? 아니면 xlsx?? -> DB**
  * DB가 개인적으로 관리하기 편해서 DB로 전부 데이터 관리하겠음.
  * 데이터 없는건 add하고 달라진건 update하고 등등 굿굿
* 네이버는 마지막에하고 **다른 사이트들 파싱 먼저!**

  * 단, 멀티스레드나 멀티프로세스 적용하면서 ㄱㄱ
  * 라이브러리도 최신껄로... 문법 무조건 다르니까 참고
  * 자바로할까 고민하긴했는데 보통 파이썬이 파싱하기엔 좋다고 하는듯

<br><br>

## 2023-10-09~10

**생각해보니 스마트스토어 동작을 짧게하려면 애초에 "기존방식대로" 해야함**

* **(참고)아이템_부속은 delete cascade로 외래키 묶기 - OK**
* **(1)네이버..로그인 -> 스마트스토어 product... 다운.. 읽기.. (기존 동일)**
  * product.xml사용하기 때문에 네이버 DB는 제거
  * 인증번호 사용하므로 인증번호 DB는 추가
* **(2)웹파싱 데이터를 product.xml에 매칭(메모리비교) 데이터들만 분류 (기존 동일)**
  * 메모리비교 빠르게끔(데이터 순서가 동일하단점 이용해서)

* **(3)분류한 데이터들 DB데이터와 비교 및 연산 (기존꺼에서 DB저장으로)**
  * db에 없으면 insert + up필드 true + 데이터 존재로 pass
  * db에 있는데 동일하면 pass + up필드 false + 데이터 존재로 pass
  * db에 있는데 다르면 update + up필드 true + 데이터 존재로 pass
  * **(3-1)나머지경우 데이터가 존재하지 않다는것이므로 delete연산**
* **(4)DB데이터 활용해서 스마트스토어 업데이트! up필드 true들만!! false는 바로 넘어가는거임!**
  * 이거 안하게 될듯. 아래 참고.


<br>

**위과정 생략하고. 새로나온!! 엑셀일괄 수정!! 이것을 사용하자!!!!!**

* 즉, 이제 흐름은 ??
* smartstore-parser : 네이버로그인 -> 로그인 한김에 상품정보.csv다운 -> page(name,url)전부 파싱 및 데이터파싱(b) 및 상품정보.csv 메모리에 읽어두기(a) ->  a와 b를 모델명(pk)끼리 비교해서 **a상품 순서대로(정렬)** 기록 및 **상품번호**는 필수 기록db(c). 전체delete후 insert
* smartstore(private) : 엑셀일괄수정.xlsx(d)다운 -> c(db)를 참고해서 d수정 -> d를 업로드 끝.
* 인증번호와 캡차내용은 둘다 메일로 받고, 사용자가 직접 메일을 내게쓰기 해서 해결
* url 다 숨기기.

<br><br>

## 2023-10-06~08

**DB 설계는??**

* 아이템테이블 : 아이템_부속테이블 
  * 1:N 관계


**깃으로 형상관리 위해 env파일 .gitignore에 추가**

* .gitignore 을 git이 인식 못하는것 같을때 캐시삭제 후 다시 push

  ```bash
  git rm -r --cached .
  git add .
  git commit -m "fixed untracked files"
  ```

**프로젝트 생성.. -> 아나콘다로 환경설정..**

* `conda install pytz python-dotenv pandas openpyxl lxml selenium requests beautifulsoup4`
* 등등 라이브러리 여러개 한번에 설치 가능

**logging 라이브러리 활용 -> 로그레벨 사용**

* 근데 아마 debug레벨로 쓸듯 함. 다른사용자가 쓰는게 아니다보니.

**셀레니움 wait은 time.sleep, implicitly_wait은 사용X -> "Explicitly Wait 사용"**

* 최초 드라이버 생성 때 설정(**Implicitly_Wait** 기본값:0) : `driver.implicitly_wait(10)`
  * 10초전에 전체 DOM 로드시 더 안기다리고 바로 다음코드 진행
  * 10초 지나도 로드 안되면 예외
  * 추가로 timeout으로 설정된 시간 만큼 최대한 대기후 timeout Exception으로 넘어 갑니다.
* 매번 필요할때 사용(**Explicitly Wait**) : `WebDriverWait(browser, 5).until(EC.presence_of_element_located((By.XPATH, "//*[@id='maker_name']")))`
  * 5초전에 해당 엘리멘트 로드시 더 안기다리고 바로 다음코드 진행
  * 5초 지나도 로드안되면 예외
  * 추가로 timeout으로 설정된 시간 만큼 최대한 대기후 timeout Exception으로 넘어 갑니다.
* Explicitly Wait 가 코드는 복잡해져도,, 디버깅은 수월해지므로 오류검출 쉽게끔 이녀석만 사용하겠음
  * 딱히 timeout은 따로 안쓰겠다.
  * **시간초과 예외처리는 try catch로! 근데, 애초에 중간에 터지면 프로그램 다시 처리해야하다보니 try catch많이 안쓸듯** 

**셀레니움 엘리멘트 값 없을때 잘 넘어가기 위해 elements를 주로 써서 빈값은 []로 받자**

**정적으로 해결되면은 `request` 라이브러리 사용, 동적은 `셀레니움` 사용!!**

* **특히 로그인 필요사이트는 셀레니움 -> `request.Session` 사용!!**
  * **셀레니움으로 물론 다 가능하지만 request가 훨씬 속도는 빠르기 때문에 사용가능하면 꼭 쓰자.**
* **중요!!**
  * **자바스크립트 사용중지 체크해서 파싱 가능하다면 "정적"-request**
  * **그게 아니라면 "동적"-selenium**
